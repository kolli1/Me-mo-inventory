<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Inventory Report ‚Äî Mochi</title>

<!-- Inter font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --cream: #fffaf0;
    --card: #ffffff;
    --muted: #2b2f33;
    --accent: #ff9aa2; /* pastel pink */
    --mint: #b6f0d1;   /* pastel mint */
    --lavender: #e7d7ff; /* pastel lavender for border */
  }
  html,body{height:100%;margin:0;background:var(--cream);font-family:Inter,Arial,sans-serif;color:var(--muted)}
  .container{max-width:640px;margin:18px auto;padding:16px}
  .panel{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 8px 22px rgba(16,24,40,0.06)}
  h1{margin:0 0 12px;font-size:20px;text-align:center;color:var(--muted)}
  .btn{display:block;width:100%;padding:12px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--accent),#ffb3b9);color:#fff;font-weight:600;cursor:pointer;font-size:15px}
  .table-wrapper{overflow-x:auto;margin-top:12px;border-radius:8px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border:1px solid rgba(16,24,40,0.06);text-align:center}
  th{background:var(--mint);color:var(--muted);font-weight:600}
  input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.06);background:#fbfbfb;color:var(--muted)}
  .small{font-size:13px;color:#6b7280;margin-top:10px;text-align:center}
  /* Report preview area (minimal) */
  #reportOutputWrapper{margin-top:12px;padding:10px;border-radius:10px;background:transparent}
  pre#reportOutput{font-family:"Courier New",monospace;white-space:pre;overflow:auto;font-size:13px;color:var(--muted);margin:0}
  /* share card (cloned for image) */
  .share-card{width:1200px;background:#ffffff;padding:28px;border-radius:18px;border:8px solid var(--lavender);box-sizing:border-box;color:#1f2937}
  .share-title{font-size:32px;font-weight:700;margin-bottom:8px}
  .share-sub{font-size:14px;color:#374151;margin-bottom:12px}
  .share-pre{font-family:"Courier New",monospace;white-space:pre;font-size:20px;line-height:1.2;color:#111827;margin:0}
  @media (max-width:460px){
    .container{padding:10px}
    th,td{padding:8px}
    .btn{padding:11px;font-size:14px}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>üç® Mochi ‚Äî Inventory</h1>

      <div style="margin-bottom:10px">
        <button id="loadBtn" class="btn">Load Inventory</button>
      </div>

      <div id="inventorySection" style="display:none">
        <div class="table-wrapper">
          <table id="skuTable" aria-hidden="false">
            <thead><tr><th>SKU</th><th>Opening</th><th>Closing</th></tr></thead>
            <tbody id="skuList"></tbody>
          </table>
        </div>
      </div>

      <div id="reportSection" style="display:none">
        <div id="reportOutputWrapper">
          <pre id="reportOutput">Please generate a report...</pre>
        </div>
        <div style="margin-top:12px">
          <button id="shareBtn" class="btn">Share Text + Image (WhatsApp)</button>
        </div>
        <div class="small">One-click: opens the system share sheet ‚Äî choose WhatsApp to send both text + image (Chrome on Android recommended).</div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
/* ----- Config & data ----- */
const DEFAULT_SKUS = ['Vanilla','Strawberry','Chocolate','Mango','Grape','Muskmelon','Coconut','Brownie','Paan'];
const STORAGE_KEY = 'mochi_inventory';
const DAILY_KEY = 'mochi_daily';
let skuData = [];

/* ----- UI render ----- */
function renderInventory(){
  const tbody = document.getElementById('skuList');
  tbody.innerHTML = '';
  skuData.forEach((s, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.name}</td>
      <td><input id="open${i}" type="number" min="0" value="${s.opening}"></td>
      <td><input id="close${i}" type="number" min="0" value="${s.closing}"></td>
    `;
    tbody.appendChild(tr);
  });
}

/* ----- load data ----- */
function loadInventory(){
  const saved = localStorage.getItem(STORAGE_KEY);
  skuData = saved ? JSON.parse(saved) : DEFAULT_SKUS.map(name => ({name, opening:0, closing:0}));
  renderInventory();
  document.getElementById('inventorySection').style.display = 'block';
  document.getElementById('reportSection').style.display = 'block';
}

/* ----- formatting for boxed table + low stock ----- */
function formatBoxedTableWithLowStock(title, data){
  const pad = (s,len) => s.toString().padEnd(len,' ');
  const skuLen = 14, openLen = 8, closeLen = 8, soldLen = 6;
  let text = title + '\n';
  text += '‚îå' + '‚îÄ'.repeat(skuLen) + '‚î¨' + '‚îÄ'.repeat(openLen) + '‚î¨' + '‚îÄ'.repeat(closeLen) + '‚î¨' + '‚îÄ'.repeat(soldLen) + '‚îê\n';
  text += '‚îÇ' + pad('SKU',skuLen) + '‚îÇ' + pad('Opening',openLen) + '‚îÇ' + pad('Closing',closeLen) + '‚îÇ' + pad('Sold',soldLen) + '‚îÇ\n';
  text += '‚îú' + '‚îÄ'.repeat(skuLen) + '‚îº' + '‚îÄ'.repeat(openLen) + '‚îº' + '‚îÄ'.repeat(closeLen) + '‚îº' + '‚îÄ'.repeat(soldLen) + '‚î§\n';

  const low = [];
  data.forEach(sku=>{
    const sold = Math.max(0, (sku.opening||0) - (sku.closing||0));
    if((sku.closing||0) < 15) low.push(sku.name);
    text += '‚îÇ' + pad(sku.name,skuLen) + '‚îÇ' + pad(sku.opening,openLen) + '‚îÇ' + pad(sku.closing,closeLen) + '‚îÇ' + pad(sold,soldLen) + '‚îÇ\n';
  });

  text += '‚îî' + '‚îÄ'.repeat(skuLen) + '‚î¥' + '‚îÄ'.repeat(openLen) + '‚î¥' + '‚îÄ'.repeat(closeLen) + '‚î¥' + '‚îÄ'.repeat(soldLen) + '‚îò\n';
  if(low.length) text += '\n‚ö† Low Stock ‚Äì To be Fulfilled: ' + low.join(', ');
  return text;
}

/* ----- share card builder (pastel compact landscape) ----- */
function buildShareCardDOM(reportText){
  const wrapper = document.createElement('div');
  wrapper.className = 'share-card';
  wrapper.style.cssText = 'width:1200px;background:linear-gradient(180deg,#ffffff,#fff9f4);padding:28px;border-radius:18px;border:8px solid ' + '#E7D7FF' + ';box-sizing:border-box;color:#111827';

  const title = document.createElement('div');
  title.className = 'share-title';
  title.textContent = 'Daily Inventory Report';
  title.style.cssText = 'font-weight:700;font-size:32px;margin-bottom:6px;color:#111827';

  const sub = document.createElement('div');
  sub.className = 'share-sub';
  sub.textContent = new Date().toLocaleDateString();
  sub.style.cssText = 'font-size:14px;color:#374151;margin-bottom:12px';

  const pre = document.createElement('pre');
  pre.className = 'share-pre';
  pre.style.cssText = 'font-family:"Courier New",monospace;white-space:pre;font-size:18px;line-height:1.2;color:#111827;margin:0';
  pre.textContent = reportText;

  wrapper.appendChild(title);
  wrapper.appendChild(sub);
  wrapper.appendChild(pre);
  return wrapper;
}

/* ----- main share handler ----- */
async function shareTextAndImageHandler(){
  try{
    // 1. Save inputs into skuData
    skuData.forEach((s,i)=>{
      s.opening = parseInt(document.getElementById('open'+i).value) || 0;
      s.closing = parseInt(document.getElementById('close'+i).value) || 0;
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(skuData));

    // 2. Save daily snapshot
    const daily = JSON.parse(localStorage.getItem(DAILY_KEY) || '[]');
    daily.push({ date: new Date().toISOString().slice(0,10), data: JSON.parse(JSON.stringify(skuData)) });
    if(daily.length > 7) daily.shift();
    localStorage.setItem(DAILY_KEY, JSON.stringify(daily));

    // 3. Carry over closing stock
    skuData.forEach(s => { s.opening = s.closing; s.closing = 0; });
    renderInventory();

    // 4. Build report text and display
    const title = 'üìÖ Daily Inventory & Sales Report ‚Äì ' + new Date().toLocaleDateString();
    const reportText = formatBoxedTableWithLowStock(title, skuData);
    document.getElementById('reportOutput').textContent = reportText;

    // 5. Build share card DOM, attach, render to canvas
    const shareCard = buildShareCardDOM(reportText);
    // add temporarily to DOM offscreen to ensure fonts & layout compute
    shareCard.style.position = 'fixed';
    shareCard.style.left = '-10000px';
    document.body.appendChild(shareCard);

    // let browser render
    await new Promise(r => setTimeout(r, 140));

    const canvas = await html2canvas(shareCard, {
      backgroundColor: null,
      scale: 2,
      useCORS: true,
      width: shareCard.scrollWidth,
      windowWidth: shareCard.scrollWidth + 40
    });

    document.body.removeChild(shareCard);
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
    const file = new File([blob], `Mochi_Report_${(new Date()).toISOString().slice(0,10)}.png`, { type: 'image/png' });

    // 6. Use Web Share API (files + text) when supported
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        title: 'Daily Inventory Report',
        text: reportText,
        files: [file]
      });
      return;
    }

    // 7. If cannot share files, open WhatsApp Web with text (minimal fallback)
    // (Per your earlier preference we avoid downloads; open wa.me with text so user can send text)
    window.open(`https://wa.me/?text=${encodeURIComponent(reportText)}`, '_blank');

  } catch (err){
    console.error('Share error', err);
    alert('An error occurred while sharing. For best experience use Chrome on Android (supports sharing files + text).');
  }
}

/* ----- wiring ----- */
document.getElementById('loadBtn').addEventListener('click', loadInventory);
document.getElementById('shareBtn').addEventListener('click', shareTextAndImageHandler);

// autoload if data present
if(localStorage.getItem(STORAGE_KEY)) loadInventory();
</script>
</body>
</html>
