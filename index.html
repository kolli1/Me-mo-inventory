<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mochi Inventory App</title>
<style>
body { font-family: Arial, sans-serif; background: #0f1724; color: #e6eef6; margin:0; padding:0; }
.container { max-width: 500px; margin: auto; padding: 15px; }
.card { background: #1e293b; padding: 18px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
h1,h2 { margin: 10px 0; text-align: center; font-size: 1.5rem; }
input, button { font-family: inherit; padding: 14px; border-radius: 10px; margin-top: 8px; width: 100%; box-sizing: border-box; font-size: 18px; border: none; }
input { background: #1e293b; color: #e6eef6; }
.btn { cursor: pointer; margin-top: 12px; background: #2563eb; color: #fff; font-weight: bold; transition: 0.3s; }
.btn:hover { background: #3b82f6; }
.table-wrapper { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; min-width: 300px; }
th, td { border: 1px solid #334155; padding: 8px; text-align: center; }
th { background: #2563eb; }
pre { white-space: pre; font-family: monospace; overflow-x: auto; padding:12px; background:#1e293b; border-radius:10px; font-size: 14px; }
.low-stock { color: #facc15; font-weight: bold; }
@media (max-width: 400px) {
  h1,h2 { font-size: 1.3rem; }
  input, button { font-size: 16px; padding:12px; }
  table th, table td { padding: 6px; font-size: 12px; }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<div class="container">

<div class="card">
  <h1>üç® Mochi Inventory</h1>
  <button class="btn" id="loadBtn">Load Inventory</button>
</div>

<div class="card" id="inventoryCard" style="display:none">
  <h2>Inventory Management</h2>
  <div class="table-wrapper">
    <table id="skuTable">
      <thead><tr><th>SKU</th><th>Opening</th><th>Closing</th></tr></thead>
      <tbody id="skuList"></tbody>
    </table>
  </div>
  <button class="btn" id="saveInventory">Save Inventory</button>
</div>

<div class="card" id="reportCard" style="display:none">
  <h2>Reports</h2>
  <button class="btn" id="combinedReportBtn">Generate Daily Report</button>
  <button class="btn" id="weeklyReportBtn">Generate Weekly Summary</button>
  <pre id="reportOutput">Please generate a report...</pre>
  <button class="btn" id="shareWhatsApp">Share Report as Image (WhatsApp)</button>
  <button class="btn" id="shareImageBtn">Share Report as Image</button>
</div>

<script>
const DEFAULT_SKUS = ['Vanilla','Strawberry','Chocolate','Mango','Grape','Muskmelon','Coconut','Brownie','Paan'];
let skuData = [];
const STORAGE_KEY = 'mochi_inventory';
const DAILY_KEY = 'mochi_daily';

// Render inventory table
function renderInventory(){
    const skuList = document.getElementById('skuList');
    skuList.innerHTML = '';
    skuData.forEach((sku, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${sku.name}</td>
            <td><input type="number" min="0" id="open${i}" value="${sku.opening}"></td>
            <td><input type="number" min="0" id="close${i}" value="${sku.closing}"></td>
        `;
        skuList.appendChild(row);
    });
}

// Load inventory
function loadInventory(){
    const saved = localStorage.getItem(STORAGE_KEY);
    skuData = saved ? JSON.parse(saved) : DEFAULT_SKUS.map(name=>({name, opening:0, closing:0}));
    renderInventory();
    document.getElementById('inventoryCard').style.display = 'block';
    document.getElementById('reportCard').style.display = 'block';
}

// Save inventory
function saveInventory(){
    skuData.forEach((sku,i)=>{
        sku.opening = parseInt(document.getElementById('open'+i).value) || 0;
        sku.closing = parseInt(document.getElementById('close'+i).value) || 0;
    });

    localStorage.setItem(STORAGE_KEY, JSON.stringify(skuData));

    // Save daily snapshot
    const daily = JSON.parse(localStorage.getItem(DAILY_KEY) || '[]');
    daily.push({date:new Date().toISOString().slice(0,10), data: JSON.parse(JSON.stringify(skuData))});
    if(daily.length>7) daily.shift();
    localStorage.setItem(DAILY_KEY, JSON.stringify(daily));

    // Carry over closing stock
    skuData.forEach(sku => { sku.opening = sku.closing; sku.closing = 0; });
    renderInventory();
    alert('Inventory saved and closing stock carried over to next day.');
}

// Boxed table formatter
function formatBoxedTableReport(title, data){
    const pad = (str, len) => str.toString().padEnd(len, ' ');
    const skuLen = 12, openLen = 7, closeLen = 7, soldLen = 5;
    let text = title + '\n';
    text += '‚îå'+'‚îÄ'.repeat(skuLen)+'‚î¨'+'‚îÄ'.repeat(openLen)+'‚î¨'+'‚îÄ'.repeat(closeLen)+'‚î¨'+'‚îÄ'.repeat(soldLen)+'‚îê\n';
    text += '‚îÇ'+pad('SKU',skuLen)+'‚îÇ'+pad('Opening',openLen)+'‚îÇ'+pad('Closing',closeLen)+'‚îÇ'+pad('Sold',soldLen)+'‚îÇ\n';
    text += '‚îú'+'‚îÄ'.repeat(skuLen)+'‚îº'+'‚îÄ'.repeat(openLen)+'‚îº'+'‚îÄ'.repeat(closeLen)+'‚îº'+'‚îÄ'.repeat(soldLen)+'‚î§\n';
    data.forEach(sku=>{
        const soldVal = sku.sold !== undefined ? sku.sold : Math.max(0, sku.opening - sku.closing);
        const lowStockNote = sku.closing < 15 ? ' ‚ö† To be fulfilled' : '';
        text += '‚îÇ'+pad(sku.name,skuLen)+'‚îÇ'+pad(sku.opening,openLen)+'‚îÇ'+pad(sku.closing,closeLen)+'‚îÇ'+pad(soldVal,soldLen)+'‚îÇ'+lowStockNote+'\n';
    });
    text += '‚îî'+'‚îÄ'.repeat(skuLen)+'‚î¥'+'‚îÄ'.repeat(openLen)+'‚î¥'+'‚îÄ'.repeat(closeLen)+'‚î¥'+'‚îÄ'.repeat(soldLen)+'‚îò\n';
    return text;
}

// Daily report
function generateCombinedReport(){
    document.getElementById('reportOutput').textContent = formatBoxedTableReport('üìÖ Daily Inventory & Sales Report ‚Äì ' + new Date().toLocaleDateString(), skuData);
}

// Weekly summary
function generateWeeklySummary(){
    const daily = JSON.parse(localStorage.getItem(DAILY_KEY) || '[]');
    if(daily.length===0){ 
        document.getElementById('reportOutput').textContent='No weekly data available'; 
        return; 
    }

    const totals = {};
    const lastDayClosing = {};
    DEFAULT_SKUS.forEach(name => { totals[name] = 0; lastDayClosing[name] = 0; });

    daily.forEach(day => { 
        day.data.forEach(sku => { 
            totals[sku.name] += Math.max(0, sku.opening - sku.closing); 
            lastDayClosing[sku.name] = sku.closing; 
        }); 
    });

    const summaryData = DEFAULT_SKUS.map(name => ({
        name,
        opening: 0,
        closing: lastDayClosing[name],
        sold: totals[name]
    }));

    document.getElementById('reportOutput').textContent = formatBoxedTableReport('üìÖ Weekly Inventory & Sales Summary ‚Äì Last '+daily.length+' Days', summaryData);
}

// Share report as image (WhatsApp/manual download)
function shareReportAsImageWhatsApp(){
    const reportDiv = document.getElementById('reportOutput');
    if(!reportDiv.textContent.trim() || reportDiv.textContent==='Please generate a report...'){ 
        alert('Generate a report first'); 
        return; 
    }
    html2canvas(reportDiv, {backgroundColor:'#0f1724'}).then(canvas=>{
        canvas.toBlob(blob=>{
            const file = new File([blob], "report.png", {type:"image/png"});
            const url = URL.createObjectURL(file);
            alert("Report image generated. Download it and share on WhatsApp manually.");
            window.open(url, '_blank');
        });
    });
}

// Share as image (general)
function shareAsImage(){
    const reportDiv=document.getElementById('reportOutput');
    if(!reportDiv.textContent.trim() || reportDiv.textContent==='Please generate a report...'){ alert('Generate a report first'); return; }
    html2canvas(reportDiv, {backgroundColor:'#0f1724'}).then(canvas=>{
        const imgData=canvas.toDataURL('image/png');
        const imgWindow=window.open('', '_blank');
        imgWindow.document.write('<img src="'+imgData+'" style="width:100%;">');
    });
}

// Event listeners
document.getElementById('loadBtn').onclick = loadInventory;
document.getElementById('saveInventory').onclick = saveInventory;
document.getElementById('combinedReportBtn').onclick = generateCombinedReport;
document.getElementById('weeklyReportBtn').onclick = generateWeeklySummary;
document.getElementById('shareWhatsApp').onclick = shareReportAsImageWhatsApp;
document.getElementById('shareImageBtn').onclick = shareAsImage;

</script>

</div>
</body>
</html>
