<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mochi Inventory ‚Äî Debugged</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --cream:#fffaf0; --card:#fff; --muted:#233; --accent1:#ff9aa2; --accent2:#ffd1dc; --mint:#B6F0D1; --lavender:#E7D7FF;
}
body{margin:0;background:linear-gradient(180deg,var(--cream),#fff9f4);font-family:Inter,Arial,sans-serif;color:var(--muted);-webkit-font-smoothing:antialiased}
.container{max-width:720px;margin:12px auto;padding:14px}
.panel{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(16,24,40,0.06)}
.header{display:flex;align-items:center;justify-content:space-between}
.title{font-weight:700;font-size:18px}
.table-wrapper{overflow:auto;margin-top:10px;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border:1px solid rgba(16,24,40,0.06);text-align:center}
th{background:var(--mint);font-weight:600}
input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.06);background:#fbfbfb}
.row{display:flex;gap:8px;margin-top:12px}
.btn{flex:1;padding:12px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--accent1),var(--accent2));color:#fff;font-weight:700;cursor:pointer}
.btn.secondary{background:linear-gradient(180deg,#9ee8c7,#bff7db);color:#073b2a}
.report{margin-top:12px;padding:12px;border-radius:8px;background:transparent}
pre#reportOutput{font-family:"Courier New",monospace;white-space:pre;overflow:auto;font-size:13px;color:var(--muted);margin:0}
.status{margin-top:12px;font-size:13px;color:#475569}
.debug{margin-top:10px;padding:8px;border-radius:8px;background:#f3f4f6;color:#111;max-height:140px;overflow:auto;font-size:12px}
.small{font-size:12px;color:#6b7280;margin-top:8px}
.share-card{width:1200px;background:linear-gradient(180deg,#ffffff,#fff9f4);padding:28px;border-radius:18px;border:8px solid var(--lavender);box-sizing:border-box;color:#111827}
.share-title{font-size:28px;font-weight:700;margin-bottom:6px}
.share-sub{font-size:14px;color:#374151;margin-bottom:10px}
.share-pre{font-family:"Courier New",monospace;white-space:pre;font-size:18px;line-height:1.2;color:#111827;margin:0}
@media (max-width:520px){.title{font-size:16px}.btn{padding:10px}}
</style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <div class="header">
        <div class="title">üç® Mochi Inventory ‚Äî Simplified</div>
        <div style="font-size:13px;color:#64748b">One-click flow: Generate ‚Üí Share</div>
      </div>

      <div id="inventoryArea" class="table-wrapper">
        <table id="skuTable" aria-hidden="false">
          <thead><tr><th>SKU</th><th>Opening</th><th>Closing</th></tr></thead>
          <tbody id="skuList"></tbody>
        </table>
      </div>

      <div class="row">
        <button id="generateBtn" class="btn">Generate & Save</button>
        <button id="shareBtn" class="btn secondary">Share (WhatsApp)</button>
      </div>

      <div class="report">
        <pre id="reportOutput">No report yet ‚Äî press Generate & Save.</pre>
      </div>

      <div class="status" id="statusLine">Status: ready</div>

      <div class="small">Best test environment: Chrome on Android (supports image+text share). If share fails, check debug box below.</div>

      <div class="debug" id="debugBox">Debug logs will appear here.</div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
/* ---------- utils ---------- */
const logDebug = (msg)=>{ const el=document.getElementById('debugBox'); el.textContent = (new Date()).toLocaleTimeString() + ' ‚Ä¢ ' + msg + '\n' + el.textContent; console.log(msg); };
const setStatus = (s)=>{ document.getElementById('statusLine').textContent = 'Status: ' + s; logDebug(s); };
const safeInt = v => { const n = parseInt(v); return Number.isNaN(n) ? 0 : n; };
const wait = ms => new Promise(r=>setTimeout(r,ms));
const canvasToBlob = (canvas, type='image/png', q=0.92) => new Promise(res=>canvas.toBlob(b=>res(b), type, q));

/* ---------- data ---------- */
const DEFAULT_SKUS = ['Vanilla','Strawberry','Chocolate','Mango','Grape','Muskmelon','Coconut','Brownie','Paan'];
const STORAGE_KEY = 'mochi_inventory';
const DAILY_KEY = 'mochi_daily';
let skuData = [];

/* ---------- UI render ---------- */
function renderInventory(){
  const tbody = document.getElementById('skuList');
  tbody.innerHTML = '';
  skuData.forEach((s,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td>
      <td><input id="open${i}" type="number" min="0" value="${s.opening}"></td>
      <td><input id="close${i}" type="number" min="0" value="${s.closing}"></td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- load ---------- */
function loadInventory(){
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    skuData = saved ? JSON.parse(saved) : DEFAULT_SKUS.map(n=>({name:n, opening:0, closing:0}));
    renderInventory();
    setStatus('Inventory loaded');
  } catch(e){
    console.error(e); setStatus('Failed to load inventory'); logDebug('loadInventory error: ' + e);
  }
}
loadInventory();

/* ---------- format ---------- */
function formatBoxedTableWithLowStock(title, data){
  const pad = (s,len)=> s.toString().padEnd(len,' ');
  const skuLen=14, openLen=8, closeLen=8, soldLen=6;
  let t = title + '\n';
  t += '‚îå'+'‚îÄ'.repeat(skuLen)+'‚î¨'+'‚îÄ'.repeat(openLen)+'‚î¨'+'‚îÄ'.repeat(closeLen)+'‚î¨'+'‚îÄ'.repeat(soldLen)+'‚îê\n';
  t += '‚îÇ'+pad('SKU',skuLen)+'‚îÇ'+pad('Opening',openLen)+'‚îÇ'+pad('Closing',closeLen)+'‚îÇ'+pad('Sold',soldLen)+'‚îÇ\n';
  t += '‚îú'+'‚îÄ'.repeat(skuLen)+'‚îº'+'‚îÄ'.repeat(openLen)+'‚îº'+'‚îÄ'.repeat(closeLen)+'‚îº'+'‚îÄ'.repeat(soldLen)+'‚î§\n';
  const low=[];
  data.forEach(sku=>{
    const sold = Math.max(0,(sku.opening||0)-(sku.closing||0));
    if((sku.closing||0) < 15) low.push(sku.name);
    t += '‚îÇ'+pad(sku.name,skuLen)+'‚îÇ'+pad(sku.opening,openLen)+'‚îÇ'+pad(sku.closing,closeLen)+'‚îÇ'+pad(sold,soldLen)+'‚îÇ\n';
  });
  t += '‚îî'+'‚îÄ'.repeat(skuLen)+'‚î¥'+'‚îÄ'.repeat(openLen)+'‚î¥'+'‚îÄ'.repeat(closeLen)+'‚î¥'+'‚îÄ'.repeat(soldLen)+'‚îò\n';
  if(low.length) t += '\n‚ö† Low Stock ‚Äì To be Fulfilled: ' + low.join(', ');
  return t;
}

/* ---------- build share card ---------- */
function buildShareCardDOM(reportText){
  const wrapper = document.createElement('div');
  wrapper.className='share-card';
  wrapper.style.cssText = 'width:1200px;background:linear-gradient(180deg,#ffffff,#fff9f4);padding:28px;border-radius:18px;border:8px solid #E7D7FF;box-sizing:border-box;color:#111827';
  const title = document.createElement('div'); title.className='share-title'; title.textContent='Daily Inventory Report';
  const sub = document.createElement('div'); sub.className='share-sub'; sub.textContent = new Date().toLocaleDateString();
  const pre = document.createElement('pre'); pre.className='share-pre'; pre.style.margin='0'; pre.textContent = reportText;
  wrapper.appendChild(title); wrapper.appendChild(sub); wrapper.appendChild(pre);
  return wrapper;
}

/* ---------- generate report ---------- */
function generateReport(){
  try{
    skuData.forEach((s,i)=>{
      s.opening = safeInt(document.getElementById('open'+i).value);
      s.closing = safeInt(document.getElementById('close'+i).value);
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(skuData));
    // daily snapshot
    const daily = JSON.parse(localStorage.getItem(DAILY_KEY) || '[]');
    daily.push({date:new Date().toISOString().slice(0,10), data: JSON.parse(JSON.stringify(skuData))});
    if(daily.length>7) daily.shift();
    localStorage.setItem(DAILY_KEY, JSON.stringify(daily));
    // build text
    const title = 'üìÖ Daily Inventory & Sales Report ‚Äì ' + new Date().toLocaleDateString();
    const text = formatBoxedTableWithLowStock(title, skuData);
    document.getElementById('reportOutput').textContent = text;
    // carry over immediately
    skuData.forEach(s=>{ s.opening = s.closing; s.closing = 0; });
    renderInventory();
    setStatus('Report generated & saved');
    return text;
  } catch(e){
    console.error(e); setStatus('Generate failed'); logDebug('generateReport error: ' + e);
    throw e;
  }
}

/* ---------- share (text + image) ---------- */
async function shareHandler(){
  try{
    setStatus('Preparing report...');
    const reportText = generateReport(); // saves & updates UI
    setStatus('Rendering image (fonts will load) ...');
    const card = buildShareCardDOM(reportText);
    card.style.position='fixed'; card.style.left='-10000px'; card.style.top='0';
    document.body.appendChild(card);

    // ensure fonts loaded
    if(document.fonts && document.fonts.ready){
      await document.fonts.ready;
      logDebug('document.fonts.ready resolved');
    } else {
      await wait(120);
      logDebug('no document.fonts API, used timeout');
    }

    // small delay to ensure layout
    await wait(80);

    const canvas = await html2canvas(card, {
      backgroundColor: null,
      scale: 2.5,
      useCORS: true,
      width: card.scrollWidth,
      windowWidth: card.scrollWidth + 40
    });
    document.body.removeChild(card);

    const blob = await canvasToBlob(canvas, 'image/png');
    if(!blob) throw new Error('Canvas to blob returned null');

    const file = new File([blob], `Mochi_Report_${(new Date()).toISOString().slice(0,10)}.png`, { type: 'image/png' });
    setStatus('Image ready ‚Äî checking share support');

    // check capability
    if(navigator.canShare && navigator.canShare({ files: [file] })){
      setStatus('Sharing via navigator.share ...');
      try{
        await navigator.share({ title: 'Daily Inventory Report', text: reportText, files: [file] });
        setStatus('Share completed');
        logDebug('navigator.share resolved successfully');
        return;
      } catch (e){
        logDebug('navigator.share threw: ' + e);
        // fall through to wa.me fallback
      }
    } else {
      logDebug('navigator.canShare not available for files on this browser');
    }

    // fallback: open WhatsApp web with text prefilled
    setStatus('Opening WhatsApp Web with text (fallback)');
    const waUrl = `https://wa.me/?text=${encodeURIComponent(reportText)}`;
    window.open(waUrl, '_blank');

  } catch(err){
    console.error(err);
    logDebug('shareHandler error: ' + err);
    setStatus('Share failed ‚Äî see debug log');
    alert('Sharing failed. For best experience use Chrome on Android (supports sharing files + text). See debug log for details.');
  }
}

/* ---------- wire UI ---------- */
document.getElementById('generateBtn').addEventListener('click', ()=>{ try{ generateReport(); alert('Report generated and saved. Press Share to send.'); }catch(e){ alert('Generate failed ‚Äî see debug'); }});
document.getElementById('shareBtn').addEventListener('click', shareHandler);

/* ---------- service worker register (optional) ---------- */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => logDebug('Service worker registered: ' + reg.scope))
      .catch(err => logDebug('Service worker register failed: ' + err));
  });
}
</script>
</body>
</html>
